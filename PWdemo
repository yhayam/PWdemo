<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>APIアカウント発行管理</title>

<style>
:root{
  --blue:#2563eb;
  --blue-light:#eaf1ff;
  --bg:#f5f7ff;
  --text:#1a2b55;
  --border:#d9e2ff;
  --danger:#d92c4a;
  --ok:#1f9d7a;
}

*{box-sizing:border-box;}
body{
  margin:0;
  font-family: system-ui, -apple-system, "Noto Sans JP", sans-serif;
  background:var(--bg);
  color:var(--text);
}

header{
  background:white;
  padding:20px 30px;
  border-bottom:3px solid var(--blue);
  font-weight:700;
  font-size:18px;
}

.container{
  max-width:1100px;
  margin:30px auto;
  padding:0 20px;
  display:grid;
  grid-template-columns: 400px 1fr;
  gap:30px;
}

.card{
  background:white;
  border:1px solid var(--border);
  border-radius:10px;
  padding:20px;
}

h2{
  margin-top:0;
  font-size:15px;
  border-left:4px solid var(--blue);
  padding-left:10px;
}

label{
  font-size:13px;
  font-weight:600;
  display:block;
  margin-bottom:5px;
}

input, textarea{
  width:100%;
  padding:10px;
  border:1px solid var(--border);
  border-radius:6px;
  margin-bottom:15px;
  font-size:14px;
}

input:focus{
  outline:none;
  border-color:var(--blue);
  box-shadow:0 0 0 3px rgba(37,99,235,.15);
}

button{
  padding:10px 15px;
  border:none;
  border-radius:6px;
  font-weight:600;
  cursor:pointer;
}

.btn-primary{
  background:var(--blue);
  color:white;
}

.btn-outline{
  background:white;
  border:1px solid var(--blue);
  color:var(--blue);
}

.notice{
  font-size:12px;
  background:var(--blue-light);
  padding:10px;
  border-radius:6px;
  margin-bottom:15px;
}

.toast{
  display:none;
  padding:10px;
  border-radius:6px;
  font-size:13px;
  margin-top:10px;
}

.toast.ok{background:#e6f7f1;color:var(--ok);}
.toast.err{background:#fdeaea;color:var(--danger);}
.toast.show{display:block;}

table{
  width:100%;
  border-collapse:collapse;
  font-size:13px;
}

th, td{
  border-bottom:1px solid var(--border);
  padding:10px;
  text-align:left;
}

th{
  background:var(--blue-light);
  font-weight:600;
}

@media(max-width:900px){
  .container{grid-template-columns:1fr;}
}
</style>
</head>

<body>

<header>外部APIアカウント発行 管理画面</header>

<div class="container">

<!-- 発行エリア -->
<div class="card">
<h2>単体発行</h2>

<label>メールアドレス</label>
<input type="email" id="email">

<label>パスワード</label>
<input type="password" id="password">

<button class="btn-primary" id="issueBtn">アカウントを発行</button>

<div class="toast" id="toast"></div>

<hr style="margin:25px 0; border:none; border-top:1px solid var(--border);">

<h2>CSV一括発行</h2>

<div class="notice">
形式：email,password の2列<br>
例）test@example.com,Passw0rd!
</div>

<button class="btn-outline" onclick="downloadTemplate()">CSVテンプレートをダウンロード</button>

<br><br>

<input type="file" id="csvFile" accept=".csv">
<textarea id="preview" placeholder="プレビュー表示" readonly></textarea>
<button class="btn-primary" id="bulkBtn" disabled>一括発行実行</button>

<div class="toast" id="bulkToast"></div>

</div>

<!-- 一覧 -->
<div class="card">
<h2>発行済み一覧</h2>

<label>検索</label>
<input type="text" id="search" placeholder="メールで検索">

<table>
<thead>
<tr>
<th>メール</th>
<th>発行日時</th>
</tr>
</thead>
<tbody id="tableBody"></tbody>
</table>

</div>
</div>

<script>
const STORAGE="accounts_simple";

function getData(){ return JSON.parse(localStorage.getItem(STORAGE)||"[]"); }
function setData(d){ localStorage.setItem(STORAGE,JSON.stringify(d)); }
function now(){ return new Date().toLocaleString(); }

function showToast(el,type,msg){
  el.className="toast "+type+" show";
  el.innerText=msg;
  setTimeout(()=>el.classList.remove("show"),4000);
}

function render(){
  const list=getData();
  const q=document.getElementById("search").value.toLowerCase();
  const body=document.getElementById("tableBody");
  body.innerHTML="";
  list.filter(a=>a.email.includes(q)).forEach(a=>{
    body.innerHTML+=`
      <tr>
        <td>${a.email}</td>
        <td>${a.date}</td>
      </tr>`;
  });
}

document.getElementById("issueBtn").onclick=()=>{
  const email=document.getElementById("email").value.trim().toLowerCase();
  const pw=document.getElementById("password").value;
  const toast=document.getElementById("toast");

  if(!email||!pw){
    showToast(toast,"err","入力が不足しています");
    return;
  }

  const list=getData();
  if(list.some(a=>a.email===email)){
    showToast(toast,"err","発行エラー：既に登録済み");
    return;
  }

  list.unshift({email,date:now()});
  setData(list);
  showToast(toast,"ok","発行しました");
  document.getElementById("email").value="";
  document.getElementById("password").value="";
  render();
};

document.getElementById("search").oninput=render;

document.getElementById("csvFile").onchange=async(e)=>{
  const file=e.target.files[0];
  const preview=document.getElementById("preview");
  const btn=document.getElementById("bulkBtn");
  if(!file)return;

  const text=await file.text();
  const rows=text.split("\n").map(r=>r.split(","));
  const list=getData();

  const parsed=rows.filter(r=>r[0])
    .map(r=>({email:r[0].trim().toLowerCase()}));

  preview.value=parsed.map((p,i)=>{
    const dup=list.some(a=>a.email===p.email);
    return `${i+1}. ${p.email} ${dup?"(重複)":""}`;
  }).join("\n");

  btn.dataset.data=JSON.stringify(parsed);
  btn.disabled=false;
};

document.getElementById("bulkBtn").onclick=()=>{
  const data=JSON.parse(document.getElementById("bulkBtn").dataset.data||"[]");
  const list=getData();
  let ok=0,dup=0;

  data.forEach(d=>{
    if(list.some(a=>a.email===d.email)){dup++;return;}
    list.unshift({email:d.email,date:now()});
    ok++;
  });

  setData(list);
  render();
  showToast(document.getElementById("bulkToast"),"ok",`成功:${ok} 重複:${dup}`);
};

function downloadTemplate(){
  const csv="email,password\nuser1@example.com,Passw0rd!\nuser2@example.com,Passw0rd!";
  const blob=new Blob([csv],{type:"text/csv"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;
  a.download="account_template.csv";
  a.click();
  URL.revokeObjectURL(url);
}

render();
</script>

</body>
</html>
